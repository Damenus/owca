apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: hammerdb
  labels:
    app: hammerdb
spec:
  serviceName: mysql
  replicas: 1
  selector:
    matchLabels:
      app: hammerdb
  template:
    metadata:
      labels:
        app: hammerdb
    spec:
      securityContext:
        fsGroup: 1000

#      nodeSelector:
#        own_ip: 100.64.176.38

      initContainers:
      - name: change-config-workload
        image: busybox
        command: [ "/bin/sh", "-c"]
        args:
          - "identifier=${podname#hammerdb-} service=${identifier%-[+[:digit:]]};
             sed \"s/MYSQL_HOST/mysql-${identifier}.mysql/;s/WORKER_NUMBER/$number_runners/\" /etc/config/workload.tcl > /etc/hammerdb/config/workload.tcl;
             sed \"s/MYSQL_HOST/mysql-${identifier}.mysql/\" /etc/config/build_workload.tcl > /etc/hammerdb/config/build_workload.tcl"
        volumeMounts:
          - name: config-volume
            mountPath: /etc/config
          - name: changed-config-volume
            mountPath: /etc/hammerdb/config
        env:
          - name: podname
            valueFrom: {fieldRef: {fieldPath: metadata.name}}
          - name: number_runners
            valueFrom: {configMapKeyRef: { name: hammerdb-parameters, key: number_runners }}

      - name: wait-for-database-init
        image: alpine:3.6
        # mysqladmin -u testuser -h mysql-0.mysql -ptestpassword status
        # Uptime: 963  Threads: 4  Questions: 1043  Slow queries: 0  Opens: 67  Flush tables: 1  Open tables: 60  Queries per second avg: 1.083
        command: [ "/bin/sh", "-c", "sleep 20" ]
        args:
          - identifier=${podname#hammerdb-} service=${identifier%-[+[:digit:]]};
        env:
          - name: podname
            valueFrom: {fieldRef: {fieldPath: metadata.name}}

      - name:  initialize-database-schema
        image: hammerdb
        command: [ "./hammerdbcli", "auto" ]
        args:  ["/etc/hammerdb/config/build_workload.tcl" ]
        volumeMounts:
          - name: changed-config-volume
            mountPath: /etc/hammerdb/config

      containers:
      - name: hammerdb
        image: hammerdb
        command: [ "./hammerdbcli", "auto" ]
        args:  ["/etc/hammerdb/config/workload.tcl" ]
        volumeMounts:
          - name: changed-config-volume
            mountPath: /etc/hammerdb/config

        # python3 /mysql-tpm-gauge/mysql_tpm_gauge.py --host mysql-0.mysql
      - name: mysql-tpm-gauge
        image: mysql_tpm_gauge
        command:
          - bash
          - -c
          - >
            identifier=${podname#hammerdb-};
            service=${identifier%-[+[:digit:]]};

            mysql_tpm_gauge_wrapper.pex
            --command 'python3 -u /mysql-tpm-gauge/mysql_tpm_gauge.py --host ${identifier}'
            --log_level DEBUG
            --stderr 0
            --labels '{\"workload\": \"hammerdb\"}'
            --metric_name_prefix 'sql_' \
            --storage_output_filename=/var/log/wrapper/metrics.prom

        env:
          - name: podname
            valueFrom: {fieldRef: {fieldPath: metadata.name}}
        volumeMounts:
          - name: var-log-wrapper
            mountPath: /var/log/wrapper

      volumes:
      - name: config-volume
        configMap:
          name: mysql-tpm-gauge-tcl-script
      - name: changed-config-volume
        emptyDir: {}

  volumeClaimTemplates: []
