apiVersion: v1
kind: Service
metadata:
  name: specjbb-backend
spec:
  clusterIP: None
  selector:
    app: specjbb-backend
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: specjbb-backend
spec:
  serviceName: specjbb-backend
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      app: specjbb-backend
  template:
    metadata:
      labels:
        app: specjbb-backend
    spec:
      nodeSelector:
        kubernetes.io/hostname: node37
      terminationGracePeriodSeconds: 0
      containers:
        - name: backend
          image: specjbb
          command:
            - sh
            - -c
            - >
              target=specjbb-controller;
              echo targeting: $target;
              java -Xms4g -Xmx4g -Xmn2g -XX:-UseBiasedLocking -XX:+UseParallelOldGC
              -Dspecjbb.controller.host=$target
              -jar /home/specjbb/specjbb2015.jar
              -m backend -G GRP1 -J JVM_A

        - name: injector
          image: specjbb
          command:
            - sh
            - -c
            - >
              target=specjbb-controller;
              echo targeting: $target;
              java
              -Dspecjbb.controller.host=$target
              -jar /home/specjbb/specjbb2015.jar
              -m txinjector -G GRP1 -J JVM_B

        - name: buzzy
          image: specjbb
          command:
            - sh
            - -c
            - >
              sleep 100000
          volumeMounts:
            - name: specjbb-config
              mountPath: /var/specjbb/

      volumes:
        - name: specjbb-config
          configMap:
            name: specjbb-config
        - name: wca-specjbb-config
          emptyDir: {}

  # required for workaround bug with kustomize https://github.com/kubernetes-sigs/kustomize/issues/504
  # when using commonLabels
  volumeClaimTemplates: []
