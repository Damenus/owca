apiVersion: v1
kind: Service
metadata:
  name: specjbb-controller
spec:
  clusterIP: None
  selector:
    app: specjbb-controller
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: specjbb-controller
spec:
  serviceName: specjbb-controller
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      app: specjbb-controller
  template:
    metadata:
      labels:
        app: specjbb-controller
    spec:
      nodeSelector:
#        goal: service
        kubernetes.io/hostname: node37
      terminationGracePeriodSeconds: 0
      containers:
        - name: controler
          env:
            - name: THREADS
              valueFrom: {configMapKeyRef: { name: specjbb, key: threads }}
            - name: cpus
              valueFrom: {configMapKeyRef: { name: specjbb, key: cpus }}
            - name: memory
              valueFrom: {configMapKeyRef: { name: specjbb, key: memory }}
            - name: report_interval
              valueFrom: {configMapKeyRef: { name: specjbb, key: report_interval}}
            - name: extra
              valueFrom: {configMapKeyRef: { name: specjbb, key: extra }}
            - name: base_cores
              valueFrom: {configMapKeyRef: { name: specjbb, key: base_cores }}
            - name: use_numa_binding
              valueFrom: {configMapKeyRef: { name: specjbb, key: use_numa_binding }}
            - name: experiment_name
              valueFrom: {configMapKeyRef: { name: specjbb, key: experiment_name }}
            - name: id_env
              valueFrom: {configMapKeyRef: { name: specjbb, key: id_env }}
            - name: specjbb_jar
              valueFrom: {configMapKeyRef: { name: specjbb, key: specjbb_jar }}
            # Java
            ## java_opts_c
            - name: contmeg
              valueFrom: {configMapKeyRef: { name: specjbb-java, key: contmeg }}
            - name: contnew
              valueFrom: {configMapKeyRef: { name: specjbb-java, key: contnew }}
            - name: ParallelGCThreads
              valueFrom: {configMapKeyRef: { name: specjbb-java, key: ParallelGCThreads }}
            ## spec_opts_c
            - name: group_count
              valueFrom: {configMapKeyRef: { name: specjbb-java, key: group_count }}

          image: specjbb
          command:
            - sh
            - -c
            - >
              target=specjbb-controller;
              echo targeting: $target;
              java
              -Xmx$(contmeg)G -Xms$(contmeg)G -Xmn$(contnew)G -XX:+AlwaysPreTouch -XX:ParallelGCThreads=$(ParallelGCThreads)
              -Dspecjbb.group.count=1 -Dspecjbb.txi.pergroup.count=1 -Dspecjbb.controller.rtcurve.warmup.step=0.5
              -Dspecjbb.forkjoin.workers=1
              -Dspecjbb.controller.host=$target
              -jar /home/specjbb/specjbb2015.jar
              -m distcontroller  -v

        - name: buzzy
          image: specjbb
          command:
            - sh
            - -c
            - >
              sleep 100000
          volumeMounts:
            - name: specjbb-config
              mountPath: /var/specjbb/

      volumes:
        - name: specjbb-config
          configMap:
            name: specjbb-config
        - name: wca-specjbb-config
          emptyDir: {}

  volumeClaimTemplates: []
