pipeline {
    agent any
    environment {
        PLAYBOOK='workloads/run_workloads.yaml'
        PROMETHEUS='http://100.64.176.12:9090'
        BUILD_COMMIT = "${GIT_COMMIT}"
        EXTRA_ANSIBLE_PARAMS = ""
        LABELS="{additional_labels: {build_number: \"${BUILD_NUMBER}\", build_node_name: \"${NODE_NAME}\", build_commit: \"${GIT_COMMIT}\"}}"
    }
    stages {
        stage('Build pex') {
            stages {
                stage("Prepare venv && build pex") {
                    steps {
                        sh('make venv')
                        sh('make check')
                        sh('make wca_package')
                    }
                }
            }
        }
        stage('Kubernetes') {
            agent { label 'kubernetes' }
            environment {
                INVENTORY='tests/e2e/demo_scenarios/common/inventory-kubernetes.yaml'
                KUBERNETES_HOST='100.64.176.34'
                CRT_PATH = '/etc/kubernetes/ssl/'
                CONFIG = 'wca_config_kubernetes.yaml'
            }
            steps {
                print('Reconfiguring wca...')
                print('CONFIG: ' + env.CONFIG)
                copy_config(env.CONFIG)
                replace_in_config()
                sh'''
                sudo cp ${WORKSPACE}/tests/e2e/demo_scenarios/common/wca_config.yml.tmp /etc/wca/wca_config.yml
                sudo cp ${WORKSPACE}/dist/wca-prm.pex /usr/bin/wca.pex
                systemctl restart wca
                '''
                sleep 60
                sh 'sudo systemctl status wca'
            }
        }

        stage('Mesos') {
            agent { label 'mesos' }
            environment {
                INVENTORY='tests/e2e/demo_scenarios/common/inventory-mesos.yaml'
                MESOS_MASTER_HOST='100.64.176.23'
                CONFIG = 'wca_config_mesos.yaml'
            }
            steps {
                print('Not done yet')
            }
        }
    }
}

def copy_config(config) {
    sh 'sudo cp ${WORKSPACE}/tests/e2e/demo_scenarios/common/${config} ${WORKSPACE}/prm/demo_scenarios/common/wca_config.yml.tmp'
}

def replace_in_config() {
    contentReplace(
        configs: [
            fileContentReplaceConfig(
                configs: [
                    fileContentReplaceItemConfig( search: 'BUILD_COMMIT', replace: "${GIT_COMMIT}", matchCount: 0),
                    fileContentReplaceItemConfig( search: 'BUILD_NUMBER', replace: "${BUILD_NUMBER}", matchCount: 0),
                    fileContentReplaceItemConfig( search: 'CRT_PATH', replace: "${CRT_PATH}", matchCount: 0)
                ],
                fileEncoding: 'UTF-8',
                filePath: "${WORKSPACE}/tests/e2e/demo_scenarios/common/wca_config.yml.tmp")])
}