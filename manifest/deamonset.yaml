apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: wca
  namespace: wca
#  labels:
#    name: wca
spec:
  selector:
    matchLabels:
      name: wca
  template:
    metadata:
      labels:
        name: wca
    spec:
      terminationGracePeriodSeconds: 10
      hostPID: true
      hostIPC: true
      hostNetwork: true
      containers:
      - name: wca
        image: 100.64.176.12:80/wca:dac1aab9e8bd8b454836a7dd51fc81d8ee1944d3
        securityContext:
          privileged: true
        env:
          - name: LOG
            value: debug
          - name: OWN_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: ENV_UNIQ_ID
            value: "'1'"
          - name: CONFIG
            value: /etc/owca/wca_config.yml
        resources:
          requests:
            cpu: 500m
            memory: 500Mi
        volumeMounts:
          - name: kubelet-cert
            mountPath: /etc/kubernetes/ssl/
            readOnly: true
          - name: wcaconfig
            mountPath: /etc/wca/
          - name: varlibwca
            mountPath: /var/lib/wca
          - name: logstorage
            mountPath: /var/log
          - name: cgroup
            mountPath: /sys/fs/cgroup/
      - name: node-exporter
        image: prom/node-exporter@sha256:ffc3e0adf58771cb2097aa0b074a6fe68b4925ba75c2e1c41f41ae656eebee11
        securityContext:
          privileged: true
        args:
          - --collector.procfs
          - /host/proc
          - --collector.sysfs
          - /host/sys
          - --collector.filesystem.ignored-mount-points
          - '"^/(sys|proc|dev|host|etc)($|/)"'
          - --collector.textfile.directory
          - /var/lib/wca
        ports:
          - containerPort: 9100
            protocol: TCP
        resources:
          requests:
            cpu: 1
            memory: 1
        volumeMounts:
          - name: varlibwca
            mountPath: /var/lib/wca
          - name: logstorage
            mountPath: /var/log
          - name: dev
            mountPath: /host/dev
          - name: proc
            mountPath: /host/proc
          - name: sys
            mountPath: /host/sys
          - name: rootfs
            mountPath: /rootfs
      volumes:
        - name: kubelet-cert
          secret:
            secretName: apiserver-kubelet-key-crt
        - name: wcaconfig
          configMap:
            name: wca-config
        - name: logstorage
          hostPath:
            path: /var/log
        - name: varlibwca
          hostPath:
            path: /var/lib/wca
        # control cgroup
        - name: cgroup
          hostPath:
            path: /sys/fs/cgroup/
        # node_exporter
        - name: proc
          hostPath:
            path: /proc
        - name: dev
          hostPath:
            path: /dev
        - name: sys
          hostPath:
            path: /sys
        - name: rootfs
          hostPath:
            path: /
