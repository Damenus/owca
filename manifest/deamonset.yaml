apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: wca
  namespace: wca
  labels:
    name: wca
spec:
  selector:
    matchLabels:
      name: wca
  template:
    metadata:
      labels:
        name: wca
    spec:
      terminationGracePeriodSeconds: 10
      hostPID: true
      hostIPC: true
      hostNetwork: true
      containers:
      - name: wca
        image: wca
        securityContext:
          privileged: true
        env:
          - name: LOG
            value: info
          - name: OWN_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: ENV_UNIQ_ID
            value: "'1'"
          - name: CONFIG
            value: /etc/owca/wca_config.yml
        resources:
          requests:
            cpu: 500m
            memory: 500Mi
        volumeMounts:
          - name: kubelet-certs
            mountPath: /etc/wca/certs/
            readOnly: true
          - name: wca-config
            mountPath: /etc/wca/
          - name: var-lib-wca
            mountPath: /var/lib/wca
          - name: log-storage
            mountPath: /var/log
          - name: cgroup
            mountPath: /sys/fs/cgroup/
      - name: node-exporter
        image: prom/node-exporter@sha256:ffc3e0adf58771cb2097aa0b074a6fe68b4925ba75c2e1c41f41ae656eebee11
        securityContext:
          privileged: true
        args:
          - --collector.procfs
          - /host/proc
          - --collector.sysfs
          - /host/sys
          - --collector.filesystem.ignored-mount-points
          - '"^/(sys|proc|dev|host|etc)($|/)"'
          - --collector.textfile.directory
          - /var/lib/wca
        ports:
          - containerPort: 9100
            protocol: TCP
        resources:
          requests:
            cpu: 1
            memory: 1
        volumeMounts:
          - name: log-storage
            mountPath: /var/log
          - name: dev
            mountPath: /host/dev
          - name: proc
            mountPath: /host/proc
          - name: sys
            mountPath: /host/sys
          - name: rootfs
            mountPath: /rootfs
      volumes:
        # Client private key and cert to communicate with kubelet
        - name: kubelet-certs
          secret:
            secretName: apiserver-kubelet-key-crt
        # Config for wca
        - name: wcaconfig
          configMap:
            name: wca-config
        # Volume to write wca log
        - name: log-storage
          emptyDir: {}
        - name: var-lib-wca
          emptyDir: {}
        # Path for owca to read cgroup
        - name: cgroup
          hostPath:
            path: /sys/fs/cgroup/
        # Paths for node_exporter to collect metrics
        - name: proc
          hostPath:
            path: /proc
        - name: dev
          hostPath:
            path: /dev
        - name: sys
          hostPath:
            path: /sys
        - name: rootfs
          hostPath:
            path: /
