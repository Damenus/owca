apiVersion: v1
kind: Pod
metadata:
  name: redis-pod
  labels:
    app: redis
spec:
  volumes:
  - name: shared-data
    emptyDir: {}
  initContainers:
  - name: prep_config
      image: redis
      command: ["sh", "-c", "set -x &&
      cp /etc/redis.conf . &&
      sed -i 's/port 6379/port $(communication_port:11211)/' redis.conf &&
      sed -i 's/bind 127.0.0.1/bind $(application_host_ip)/' redis.conf"]
      volumeMounts:
        - name: shared-data
          mountPath: /
  - name: init-mydb
    image: busybox
    command: ['sh', '-c', 'until nslookup mydb; do echo waiting for mydb; sleep 2; done;']
  containers:
  - name: redis
    image: redis
    volumeMounts:
      - name: shared-data
        mountPath: /
    env:
      - name: GREETING
        value: "Warm greetings to"
      - name: HONORIFIC
        value: "The Most Honorable"
      - name: NAME
        value: "Kubernetes"
      - name: NAME_work
        value: '${NAME:beats}' # local name: ${ENV:default}
    command: ["echo"]
    args: ["$(GREETING) $(HONORIFIC) $(NAME)"]
    #command: ['sh', '-c', 'echo The app is running! && sleep 3600']
  - name: redis
      image: redis
      volumeMounts:
        - name: shared-data
          mountPath: /
      command: ["redis-server"]
      args: ["redis.conf"]
