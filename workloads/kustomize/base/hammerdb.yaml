apiVersion: apps/v1
kind: Deployment
metadata:
  name: hammerdb
  labels:
    app: hammerdb
spec:
  replicas: 2
  selector:
    matchLabels:
      app: hammerdb
  template:
    metadata:
      labels:
        app: hammerdb
    spec:
      nodeSelector:
        own_ip: 100.64.176.38

      initContainers:
      - name: change-config-workload
        image: alpine:3.6
        command: [ "/bin/sh" ]
        args:  ["-c", "sleep 1" ]
        volumeMounts:
          - name: config-volume
            mountPath: /etc/config
          - name: changed-config-volume
            mountPath: /etc/hammerdb/config

      containers:
      - name: hammerdb
        image: 100.64.176.12:80/wca/hammerdb:e1d2c587b125fb38dd705a8959c08f150372fe4e
        command: [ "./hammerdbcli" ]
        args:  ["auto", "/etc/config/workload.tcl" ]
        volumeMounts:
          - name: config-volume
            mountPath: /etc/config
          - name: changed-config-volume
            mountPath: /etc/hammerdb/config
        securityContext:
          runAsUser: 0

      - name: mysql-tpm-gauge
        image: 100.64.176.12:80/wca/mysql_tpm_gauge:eb8d688d27cf3034208926a2c01426b76ee4a210
        command: [ "/bin/sh" ]
        args:  ["-c", "$(COMMAND)" ]
        securityContext:
          runAsUser: 0
        env:
        - name: COMMAND
          valueFrom:
            configMapKeyRef:
              name: mysql-tpm-gauge-command
              key: COMMAND

      volumes:
      - name: config-volume
        configMap:
          name: mysql-tpm-gauge-tcl-script
      - name: changed-config-volume
        emptyDir: {}
