apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: hammerdb
  labels:
    app: hammerdb
spec:
  serviceName: mysql
  replicas: 1
  selector:
    matchLabels:
      app: hammerdb
  template:
    metadata:
      labels:
        app: hammerdb
    spec:
      nodeSelector:
        own_ip: 100.64.176.38

      initContainers:
      - name: change-config-workload
        image: busybox
        command: [ "/bin/sh", "-c"]
        args:
          - "identifier=${podname#hammerdb-} service=${identifier%-[+[:digit:]]};
             sed \"s/MYSQL_HOST/mysql-${identifier}.mysql/\" /etc/config/workload.tcl > /etc/hammerdb/config/workload.tcl"
        volumeMounts:
          - name: config-volume
            mountPath: /etc/config
          - name: changed-config-volume
            mountPath: /etc/hammerdb/config
        env:
          - name: podname
            valueFrom: {fieldRef: {fieldPath: metadata.name}}

      - name: wait-for-database-init
        image: alpine:3.6
        command: [ "/bin/sh", "-c" ]
        args:
          - identifier=${podname#hammerdb-} service=${identifier%-[+[:digit:]]};
        env:
          - name: podname
            valueFrom: {fieldRef: {fieldPath: metadata.name}}

      containers:
      - name: hammerdb
        image: 100.64.176.12:80/wca/hammerdb:e1d2c587b125fb38dd705a8959c08f150372fe4e
        command: [ "./hammerdbcli", "auto" ]
        args:  ["/etc/hammerdb/config/workload.tcl" ]
        volumeMounts:
          - name: changed-config-volume
            mountPath: /etc/hammerdb/config

      - name: mysql-tpm-gauge
        image: 100.64.176.12:80/wca/mysql_tpm_gauge:9f62e18158481ccd051ce66cbd09a0f2b6b52237
        command: [ "/bin/bash", "-c" ]
        args:  ["$(COMMAND)" ]
        env:
        - name: COMMAND
          valueFrom:
            configMapKeyRef:
              name: mysql-tpm-gauge-command
              key: COMMAND

      volumes:
      - name: config-volume
        configMap:
          name: mysql-tpm-gauge-tcl-script
      - name: changed-config-volume
        emptyDir: {}
